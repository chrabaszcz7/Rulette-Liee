<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends - Rulette Lie</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-user">
                <a href="profile.html" class="user-card">
                    <div class="user-avatar" id="sidebarAvatar">?</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-tag" id="sidebarTag">#00000</div>
                        <div class="user-coins">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12h8M12 8v8" stroke="#0f0f1a" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span id="sidebarCoins">0</span>
                        </div>
                    </div>
                </a>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Home</span></a>
                <a href="leaderboard.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg><span>Leaderboard</span></a>
                <a href="friends.html" class="nav-item active"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Friends</span><div class="nav-indicator"></div></a>
                <a href="shop.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2l1.5 4h9L18 2"></path><path d="M3 6h18l-1.5 14h-15z"></path><circle cx="9" cy="20" r="1"></circle><circle cx="15" cy="20" r="1"></circle></svg><span>Shop</span></a>
                <a href="inventory.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18v13H3z"></path><path d="M16 3H8l-2 4h12z"></path></svg><span>Inventory</span></a>
                <a href="settings.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Settings</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg><span>Rulette Lie</span></div>
                <button class="btn btn-ghost btn-logout" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>Sign Out</span></button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="mobile-topbar">
                <button class="btn btn-ghost btn-icon mobile-menu-btn" data-sidebar-toggle aria-label="Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="mobile-title">Rulette Lie</div>
                <div class="mobile-spacer"></div>
            </div>
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="page-header">
                    <h1 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Friends
                    </h1>
                    <p class="page-subtitle">Manage your friends and view profiles</p>
                </div>

                <!-- Search Profiles -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                            Search Profiles
                        </h3>
                    </div>
                    <p class="text-muted mb-2">Search by full nickname (nickname#TAG)</p>
                    <div class="friend-add-row" style="display: flex; gap: 0.75rem;">
                        <div style="flex: 1; position: relative;">
                            <svg style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" id="friendInput" class="form-input" style="padding-left: 2.75rem; font-family: monospace;" placeholder="nickname#A1B2C">
                        </div>
                        <button class="btn btn-neon" onclick="searchProfile()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                            View Profile
                        </button>
                    </div>
                    <p class="form-error" id="addFriendError"></p>
                </div>

                <!-- Pending Requests -->
                <div class="card glass" id="pendingCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="color: var(--neon-pink);"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            Pending Requests
                        </h3>
                        <span class="badge badge-purple" id="pendingCount">0</span>
                    </div>
                    <div id="pendingList"></div>
                </div>

                <!-- Friends List -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="color: var(--neon-cyan);"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Your Friends
                        </h3>
                        <span class="badge badge-cyan" id="friendsCount">0</span>
                    </div>
                    <div id="friendsList">
                        <div class="text-center" style="padding: 3rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64" style="color: var(--text-muted); margin-bottom: 1rem;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <p class="text-muted">No friends yet</p>
                            <p style="color: var(--text-muted); font-size: 0.85rem;">Search profiles and add friends from their profile page</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal glass">
            <div class="modal-header">
                <h2 class="modal-title" id="profileModalName">Profile</h2>
                <p class="modal-desc" id="profileModalTag">#00000</p>
            </div>
            <div class="text-center">
                <div class="profile-avatar" id="profileModalAvatar" style="margin: 0 auto 1rem;">?</div>
            </div>
            <div class="text-muted text-center mb-2" id="profileModalBio"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeProfileModal()">Close</button>
                <button class="btn btn-neon" id="viewProfileBtn">View Full Profile</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/ui.js"></script>
    <script>
        let currentUser = null;
        let friends = [];

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                currentUser = { id: doc.id, ...doc.data() };
                currentUser = await ensureEloSeason(currentUser);
                window.__currentUser = currentUser;
                updateSidebar();
                loadPendingRequests();
                loadFriends();
                if (typeof subscribeNotifications === 'function') subscribeNotifications();
            }
        });

        function updateSidebar() {
            document.getElementById('sidebarCoins').textContent = currentUser.coins || 0;
            document.getElementById('sidebarName').innerHTML = renderNickHTML(currentUser.nickname, currentUser.activeNickEffect, currentUser.profileBadge);
            document.getElementById('sidebarTag').textContent = '#' + currentUser.suffix;
            document.getElementById('sidebarAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();
            if (currentUser.avatarUrl) {
                document.getElementById('sidebarAvatar').innerHTML = `<img src="${currentUser.avatarUrl}" alt="Avatar">`;
            }
            applyAvatarFrame(document.getElementById('sidebarAvatar'), currentUser.avatarFrame);
        }

        function loadPendingRequests() {
            db.collection('friendRequests')
                .where('toUserId', '==', currentUser.id)
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const card = document.getElementById('pendingCard');
                    const list = document.getElementById('pendingList');
                    const count = document.getElementById('pendingCount');

                    if (requests.length === 0) {
                        card.style.display = 'none';
                        return;
                    }

                    card.style.display = 'block';
                    count.textContent = requests.length;

                    list.innerHTML = requests.map(req => `
                        <div class="friend-item" onclick="openProfileModal('${req.fromUserId}')">
                            <div class="friend-avatar ${getAvatarFrameClass(req.fromAvatarFrame)}">
                                ${req.fromAvatarUrl ? `<img src="${req.fromAvatarUrl}" alt="Avatar">` : req.fromNickname.charAt(0).toUpperCase()}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${renderNickHTML(req.fromNickname, req.fromNickEffect, req.fromProfileBadge)}</div>
                                <div class="friend-tag">#${req.fromSuffix}</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn btn-success btn-sm" onclick="acceptRequest('${req.id}', '${req.fromUserId}'); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectRequest('${req.id}'); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                        </div>
                    `).join('');
                });
        }

        function loadFriends() {
            db.collection('users').doc(currentUser.id).collection('friends').onSnapshot(async (snapshot) => {
                const friendIds = snapshot.docs.map(doc => doc.data().userId);
                
                if (friendIds.length === 0) {
                    document.getElementById('friendsCount').textContent = '0';
                    document.getElementById('friendsList').innerHTML = `
                        <div class="text-center" style="padding: 3rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64" style="color: var(--text-muted); margin-bottom: 1rem;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <p class="text-muted">No friends yet</p>
                            <p style="color: var(--text-muted); font-size: 0.85rem;">Add friends using their nickname#tag</p>
                        </div>
                    `;
                    return;
                }

                // Fetch friend data
                friends = [];
                for (const friendId of friendIds) {
                    const friendDoc = await db.collection('users').doc(friendId).get();
                    if (friendDoc.exists) {
                        friends.push({ id: friendDoc.id, ...friendDoc.data() });
                    }
                }

                document.getElementById('friendsCount').textContent = friends.length;
                    document.getElementById('friendsList').innerHTML = friends.map(friend => `
                    <div class="friend-item" onclick="openProfileModal('${friend.id}')">
                        <div class="friend-avatar ${getAvatarFrameClass(friend.avatarFrame)}" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue));">
                            ${friend.avatarUrl ? `<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : friend.nickname.charAt(0).toUpperCase()}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${renderNickHTML(friend.nickname, friend.activeNickEffect, friend.profileBadge)}</div>
                            <div class="friend-tag">#${friend.suffix}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeFriend('${friend.id}', '${friend.nickname}'); event.stopPropagation();" style="opacity: 0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="18" y1="11" x2="23" y2="11"></line></svg>
                        </button>
                    </div>
                `).join('');
            });
        }

        async function searchProfile() {
            const input = document.getElementById('friendInput');
            const errorEl = document.getElementById('addFriendError');
            const fullNickname = input.value.trim();

            errorEl.classList.remove('show');

            if (!fullNickname.includes('#')) {
                errorEl.textContent = 'Invalid format. Use: nickname#XXXXX';
                errorEl.classList.add('show');
                return;
            }

            const [nickname, suffix] = fullNickname.split('#');

            try {
                // Find user
                const snapshot = await db.collection('users')
                    .where('nickname', '==', nickname)
                    .where('suffix', '==', suffix)
                    .get();

                if (snapshot.empty) {
                    errorEl.textContent = 'User not found';
                    errorEl.classList.add('show');
                    return;
                }

                const targetUser = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };

                input.value = '';
                window.location.href = `profile.html?id=${targetUser.id}`;
            } catch (error) {
                errorEl.textContent = 'Failed to search';
                errorEl.classList.add('show');
                console.error(error);
            }
        }

        async function acceptRequest(requestId, fromUserId) {
            try {
                await db.collection('friendRequests').doc(requestId).update({ status: 'accepted' });

                // Add to both friends lists
                await db.collection('users').doc(currentUser.id).collection('friends').add({
                    userId: fromUserId,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('users').doc(fromUserId).collection('friends').add({
                    userId: currentUser.id,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('Friend added!', 'success');
            } catch (error) {
                showToast('Failed to accept', 'error');
                console.error(error);
            }
        }

        async function rejectRequest(requestId) {
            await db.collection('friendRequests').doc(requestId).update({ status: 'rejected' });
            showToast('Request rejected', 'info');
        }

        async function removeFriend(friendId, friendName) {
            if (!confirm(`Remove ${friendName} from friends?`)) return;

            try {
                // Remove from current user
                const myFriends = await db.collection('users').doc(currentUser.id)
                    .collection('friends').where('userId', '==', friendId).get();
                myFriends.docs.forEach(doc => doc.ref.delete());

                // Remove from friend
                const theirFriends = await db.collection('users').doc(friendId)
                    .collection('friends').where('userId', '==', currentUser.id).get();
                theirFriends.docs.forEach(doc => doc.ref.delete());

                showToast('Friend removed', 'info');
            } catch (error) {
                showToast('Failed to remove', 'error');
                console.error(error);
            }
        }

        document.getElementById('friendInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProfile();
        });

        async function openProfileModal(userId) {
            const modal = document.getElementById('profileModal');
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) return;
            const u = userDoc.data();
            document.getElementById('profileModalName').innerHTML = renderNickHTML(u.nickname, u.activeNickEffect, u.profileBadge);
            document.getElementById('profileModalTag').textContent = '#' + u.suffix;
            const avatar = document.getElementById('profileModalAvatar');
            avatar.textContent = (u.nickname || '?').charAt(0).toUpperCase();
            if (u.avatarUrl) avatar.innerHTML = `<img src="${u.avatarUrl}" alt="Avatar">`;
            applyAvatarFrame(avatar, u.avatarFrame);
            document.getElementById('profileModalBio').textContent = u.bio || '';
            const btn = document.getElementById('viewProfileBtn');
            btn.onclick = () => window.location.href = `profile.html?id=${userId}`;
            modal.classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        document.getElementById('profileModal').addEventListener('click', (e) => {
            if (e.target.id === 'profileModal') closeProfileModal();
        });

        function logout() {
            auth.signOut().then(() => window.location.href = 'login.html');
        }
    </script>
</body>
</html>

