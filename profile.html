<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Rulette Lie</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-user">
                <a href="profile.html" class="user-card">
                    <div class="user-avatar" id="sidebarAvatar">?</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-tag" id="sidebarTag">#00000</div>
                        <div class="user-coins">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12h8M12 8v8" stroke="#0f0f1a" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span id="sidebarCoins">0</span>
                        </div>
                    </div>
                </a>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span>Home</span>
                </a>
                <a href="leaderboard.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    <span>Leaderboard</span>
                </a>
                <a href="friends.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Friends</span>
                </a>
                <a href="shop.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2l1.5 4h9L18 2"></path><path d="M3 6h18l-1.5 14h-15z"></path><circle cx="9" cy="20" r="1"></circle><circle cx="15" cy="20" r="1"></circle></svg>
                    <span>Shop</span>
                </a>
                <a href="inventory.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18v13H3z"></path><path d="M16 3H8l-2 4h12z"></path></svg>
                    <span>Inventory</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
                    <span>Rulette Lie</span>
                </div>
                <button class="btn btn-ghost btn-logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="mobile-topbar">
                <button class="btn btn-ghost btn-icon mobile-menu-btn" data-sidebar-toggle aria-label="Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="mobile-title">Rulette Lie</div>
                <div class="mobile-spacer"></div>
            </div>
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Profile Card -->
                <div class="card glass" style="padding: 0; overflow: hidden;">
                    <div class="profile-banner"></div>
                    <div class="profile-content" style="padding: 1.5rem;">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar" id="profileAvatar">?</div>
                        </div>
                        <div class="profile-info">
                            <h1 class="profile-name" id="profileName">Loading...</h1>
                            <p class="profile-tag" id="profileTag">#00000</p>
                            <p class="profile-full-id">Full ID: <span id="profileFullId">...</span></p>
                            <p class="text-muted" id="profileBio" style="margin-top: 0.5rem;"></p>
                            <div class="mt-2" id="profileActions"></div>
                            <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                <div class="rank-badge" id="profileRankBadge" title="">
                                    <span class="rank-dot"></span>
                                    <span id="profileRankLabel">Level 0</span>
                                </div>
                                <div class="elo-text" id="profileElo">0 ELO</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid profile-stats-grid mt-3" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(34, 197, 94, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-green);">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                            </svg>
                        </div>
                        <p class="stat-value green" id="profileWins">0</p>
                        <p class="stat-label">Wins</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(239, 68, 68, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--error);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                        </div>
                        <p class="stat-value red" id="profileLosses">0</p>
                        <p class="stat-label">Losses</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-blue);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                        </div>
                        <p class="stat-value blue" id="profileTotal">0</p>
                        <p class="stat-label">Total Games</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-purple);">
                                <line x1="19" y1="5" x2="5" y2="19"></line>
                                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                                <circle cx="17.5" cy="17.5" r="2.5"></circle>
                            </svg>
                        </div>
                        <p class="stat-value purple" id="profileWinrate">0%</p>
                        <p class="stat-label">Win Rate</p>
                    </div>
                </div>

                <!-- Performance -->
                <div class="card glass mt-3">
                    <h3 class="card-title mb-2">Performance</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="text-muted">Win Rate</span>
                            <span id="perfWinrate">0%</span>
                        </div>
                        <div style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
                            <div id="winrateBar" style="height: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-pink)); border-radius: 6px; width: 0%; transition: width 1s ease;"></div>
                        </div>
                    </div>
                    <div class="profile-performance-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <p class="text-muted" style="font-size: 0.85rem;">Games Won</p>
                            <p><span style="font-size: 1.5rem; font-weight: bold; color: var(--neon-green);" id="perfWins">0</span> <span class="text-muted" id="perfWinsTotal">/ 0</span></p>
                        </div>
                        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <p class="text-muted" style="font-size: 0.85rem;">Games Lost</p>
                            <p><span style="font-size: 1.5rem; font-weight: bold; color: var(--error);" id="perfLosses">0</span> <span class="text-muted" id="perfLossesTotal">/ 0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Game History -->
                <div class="card glass mt-3">
                    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <h3 class="card-title">Game History</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-neon btn-sm" id="historyBtnRecent" onclick="setHistoryFilter('recent')">Last 5</button>
                            <button class="btn btn-ghost btn-sm" id="historyBtnAll" onclick="setHistoryFilter('all')">All</button>
                        </div>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="text-center text-muted" style="padding: 1rem;">No history yet</div>
                    </div>
                </div>

                <div class="card glass mt-3">
                    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <h3 class="card-title">Inventory</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-neon btn-sm" id="invBtnRecent" onclick="setInventoryFilter('recent')">Last 5</button>
                            <button class="btn btn-ghost btn-sm" id="invBtnAll" onclick="setInventoryFilter('all')">All</button>
                        </div>
                    </div>
                    <div id="profileInventoryList" class="text-muted profile-inventory-list" style="padding: 0.5rem 0;">No items</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/ui.js"></script>
    <script>
        let currentUser = null;
        let viewedUser = null;
        let historyUnsub = null;
        let historyLimit = 5;
        let historyFilter = 'recent';
        let inventoryFilter = 'recent';
        let viewedUnsub = null;

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Subscribe to realtime updates
            db.collection('users').doc(user.uid).onSnapshot(async (doc) => {
                if (!doc.exists) return;
                currentUser = { id: doc.id, ...doc.data() };
                currentUser = await ensureEloSeason(currentUser);
                updateSidebar();

                const urlParams = new URLSearchParams(window.location.search);
                const viewId = urlParams.get('id') || currentUser.id;
                if (viewedUnsub) viewedUnsub();
                viewedUnsub = db.collection('users').doc(viewId).onSnapshot((uDoc) => {
                    if (!uDoc.exists) return;
                    viewedUser = { id: uDoc.id, ...uDoc.data() };
                    renderProfile();
                });
            });
        });

        function updateSidebar() {
            if (!currentUser) return;
            document.getElementById('sidebarCoins').textContent = currentUser.coins || 0;
            document.getElementById('sidebarName').innerHTML = renderNickHTML(currentUser.nickname, currentUser.activeNickEffect, currentUser.profileBadge);
            document.getElementById('sidebarTag').textContent = '#' + currentUser.suffix;
            document.getElementById('sidebarAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();
            if (currentUser.avatarUrl) {
                document.getElementById('sidebarAvatar').innerHTML = `<img src="${currentUser.avatarUrl}" alt="Avatar">`;
            }
            applyAvatarFrame(document.getElementById('sidebarAvatar'), currentUser.avatarFrame);
        }

        function renderProfile() {
            if (!currentUser || !viewedUser) return;

            const isOwn = currentUser.id === viewedUser.id;
            applyProfileTheme(viewedUser);
            document.getElementById('profileName').innerHTML = renderNickHTML(viewedUser.nickname, viewedUser.activeNickEffect, viewedUser.profileBadge);
            document.getElementById('profileTag').textContent = '#' + viewedUser.suffix;
            document.getElementById('profileFullId').textContent = formatNickname(viewedUser.nickname, viewedUser.suffix);
            document.getElementById('profileAvatar').textContent = viewedUser.nickname.charAt(0).toUpperCase();
            document.getElementById('profileBio').textContent = viewedUser.bio || '';

            if (viewedUser.avatarUrl) {
                document.getElementById('profileAvatar').innerHTML = `<img src="${viewedUser.avatarUrl}" alt="Avatar">`;
            }

            const elo = viewedUser.elo || 0;
            const rankLevel = viewedUser.eloRankLevel || getEloLevel(elo);
            const seasonLabel = getSeasonLabel(viewedUser.eloSeasonKey || getSeasonKey());
            document.getElementById('profileRankLabel').textContent = `Level ${rankLevel}`;
            document.getElementById('profileRankBadge').title = seasonLabel;
            document.getElementById('profileElo').textContent = `${elo} ELO`;

            const wins = viewedUser.wins || 0;
            const losses = viewedUser.losses || 0;
            const total = viewedUser.totalGames || 0;
            const winrate = calculateWinrate(wins, losses);

            document.getElementById('profileWins').textContent = wins;
            document.getElementById('profileLosses').textContent = losses;
            document.getElementById('profileTotal').textContent = total;
            document.getElementById('profileWinrate').textContent = winrate + '%';

            document.getElementById('perfWinrate').textContent = winrate + '%';
            document.getElementById('winrateBar').style.width = winrate + '%';
            document.getElementById('perfWins').textContent = wins;
            document.getElementById('perfWinsTotal').textContent = '/ ' + total;
            document.getElementById('perfLosses').textContent = losses;
            document.getElementById('perfLossesTotal').textContent = '/ ' + total;

            const actions = document.getElementById('profileActions');
            actions.innerHTML = '';
            if (!isOwn) {
                checkIsFriend(viewedUser.id).then(isFriend => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-neon btn-sm';
                    btn.textContent = isFriend ? 'Friend' : 'Add Friend';
                    btn.disabled = isFriend;
                    if (!isFriend) btn.onclick = () => sendFriendRequestFromProfile(viewedUser);
                    actions.appendChild(btn);
                });
            }

            if (isOwn) {
                loadHistory();
            } else {
                document.getElementById('historyList').innerHTML = '<div class="text-center text-muted" style="padding: 1rem;">Private</div>';
            }

            renderInventoryList(viewedUser);
        }

        function updateHistoryButtons() {
            const recentBtn = document.getElementById('historyBtnRecent');
            const allBtn = document.getElementById('historyBtnAll');
            if (!recentBtn || !allBtn) return;
            recentBtn.className = historyFilter === 'recent' ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';
            allBtn.className = historyFilter === 'all' ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';
        }

        function setHistoryFilter(mode) {
            if (historyFilter === mode) return;
            historyFilter = mode;
            historyLimit = mode === 'recent' ? 5 : 1000;
            updateHistoryButtons();
            if (historyUnsub) {
                historyUnsub();
                historyUnsub = null;
            }
            loadHistory();
        }

        function updateInventoryButtons() {
            const recentBtn = document.getElementById('invBtnRecent');
            const allBtn = document.getElementById('invBtnAll');
            if (!recentBtn || !allBtn) return;
            recentBtn.className = inventoryFilter === 'recent' ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';
            allBtn.className = inventoryFilter === 'all' ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';
        }

        function setInventoryFilter(mode) {
            if (inventoryFilter === mode) return;
            inventoryFilter = mode;
            updateInventoryButtons();
            renderInventoryList(viewedUser);
        }

        function applyProfileTheme(user) {
            const bannerEl = document.querySelector('.profile-banner');
            const avatarEl = document.getElementById('profileAvatar');
            const themeClasses = ['theme-red', 'theme-green', 'theme-pink', 'theme-purple', 'theme-blue', 'theme-black', 'theme-white'];
            const frameClasses = ['avatar-frame-red', 'avatar-frame-green', 'avatar-frame-rainbow', 'avatar-frame-purple', 'avatar-frame-blue', 'avatar-frame-black', 'avatar-frame-white'];

            bannerEl.classList.remove(...themeClasses);
            bannerEl.style.backgroundImage = '';

            if (user.bannerUrl) {
                bannerEl.style.backgroundImage = `url('${user.bannerUrl}')`;
                bannerEl.style.backgroundSize = 'cover';
                bannerEl.style.backgroundPosition = 'center';
            } else if (user.profileTheme && user.profileTheme !== 'default') {
                bannerEl.classList.add(`theme-${user.profileTheme}`);
            }

            avatarEl.classList.remove(...frameClasses);
            if (user.avatarFrame && user.avatarFrame !== 'default') {
                avatarEl.classList.add(`avatar-frame-${user.avatarFrame}`);
            }
        }

        function renderInventoryList(user) {
            const list = document.getElementById('profileInventoryList');
            const items = Array.isArray(user.inventory) ? user.inventory : [];
            if (!items.length) {
                list.textContent = 'No items';
                return;
            }
            const counts = items.reduce((acc, id) => {
                acc[id] = (acc[id] || 0) + 1;
                return acc;
            }, {});
            const labelMap = {
                'nick-neon-rainbow': 'Colorful neon nickname',
                'nick-neon-red': 'Red neon nickname',
                'nick-neon-blue': 'Blue neon nickname',
                'nick-neon-green': 'Green neon nickname',
                'profile-banner': 'Profile banner',
                'profile-theme-red': 'Profile theme: Red',
                'profile-theme-green': 'Profile theme: Green',
                'profile-theme-pink': 'Profile theme: Pink',
                'profile-theme-purple': 'Profile theme: Purple',
                'profile-theme-blue': 'Profile theme: Blue',
                'profile-theme-black': 'Profile theme: Black',
                'profile-theme-white': 'Profile theme: White',
                'avatar-frame-red': 'Avatar frame: Red',
                'avatar-frame-green': 'Avatar frame: Green',
                'avatar-frame-rainbow': 'Avatar frame: Rainbow',
                'avatar-frame-purple': 'Avatar frame: Purple',
                'avatar-frame-blue': 'Avatar frame: Blue',
                'avatar-frame-black': 'Avatar frame: Black',
                'avatar-frame-white': 'Avatar frame: White',
                'badge-middle-finger': 'Badge: 🖕🏻',
                'badge-blind': 'Badge: 🧑🏻‍🦯',
                'badge-rose': 'Badge: 🥀',
                'badge-skull': 'Badge: 💀',
                'badge-wheelchair': 'Badge: 🧑🏻‍🦽'
            };
            const ids = Object.keys(counts);
            const visibleIds = inventoryFilter === 'recent' ? ids.slice(0, 5) : ids;
            list.innerHTML = visibleIds.map(id => {
                const label = labelMap[id] || id;
                const content = formatInventoryLabel(id, label);
                return `<div class="inventory-item"><div>${content} (${counts[id]})</div></div>`;
            }).join('');
            updateInventoryButtons();
        }

        function formatInventoryLabel(id, label) {
            if (id.startsWith('nick-')) return renderNickHTML(label, id);
            if (id === 'profile-theme-red') return `<span class="nick nick-neon-red">${label}</span>`;
            if (id === 'profile-theme-green') return `<span class="nick nick-neon-green">${label}</span>`;
            if (id === 'profile-theme-blue') return `<span class="nick nick-neon-blue">${label}</span>`;
            if (id === 'profile-theme-pink') return `<span style="color:#ec4899;">${label}</span>`;
            if (id === 'profile-theme-purple') return `<span style="color:#a855f7;">${label}</span>`;
            if (id === 'profile-theme-black') return `<span style="color:#111827;">${label}</span>`;
            if (id === 'profile-theme-white') return `<span style="color:#f8fafc;">${label}</span>`;
            if (id === 'avatar-frame-rainbow') return `<span class="nick nick-neon-rainbow">${label}</span>`;
            if (id === 'avatar-frame-red') return `<span class="nick nick-neon-red">${label}</span>`;
            if (id === 'avatar-frame-green') return `<span class="nick nick-neon-green">${label}</span>`;
            if (id === 'avatar-frame-blue') return `<span class="nick nick-neon-blue">${label}</span>`;
            return label;
        }

        async function checkIsFriend(userId) {
            const snap = await db.collection('users').doc(currentUser.id).collection('friends')
                .where('userId', '==', userId).get();
            return !snap.empty;
        }

        async function sendFriendRequestFromProfile(user) {
            try {
                const existing = await db.collection('friendRequests')
                    .where('fromUserId', '==', currentUser.id)
                    .where('toUserId', '==', user.id)
                    .where('status', '==', 'pending')
                    .get();
                if (!existing.empty) {
                    showToast('Request already sent', 'info');
                    return;
                }
                await db.collection('friendRequests').add({
                    fromUserId: currentUser.id,
                    fromNickname: currentUser.nickname,
                    fromSuffix: currentUser.suffix,
                    fromNickEffect: currentUser.activeNickEffect || null,
                    fromProfileBadge: currentUser.profileBadge || null,
                    fromAvatarUrl: currentUser.avatarUrl || null,
                    fromAvatarFrame: currentUser.avatarFrame || 'default',
                    toUserId: user.id,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Friend request sent', 'success');
            } catch (e) {
                showToast('Failed to send request', 'error');
            }
        }

        function loadHistory() {
            if (!currentUser || !currentUser.id) return;
            if (historyUnsub) return;
            historyUnsub = db.collection('users').doc(currentUser.id).collection('history')
                .orderBy('createdAt', 'desc')
                .limit(historyLimit)
                .onSnapshot((snap) => {
                    const list = document.getElementById('historyList');
                    if (snap.empty) {
                        list.innerHTML = '<div class="text-center text-muted" style="padding: 1rem;">No history yet</div>';
                        return;
                    }
                    list.innerHTML = snap.docs.map(doc => {
                        const h = doc.data();
                        const delta = h.eloDelta || 0;
                        const isWin = delta >= 0;
                        const arrow = isWin ? '▲' : '▼';
                        const cls = isWin ? 'win' : 'lose';
                        return `
                            <div class="history-item">
                                <div class="history-meta">
                                    <div class="history-date">${formatDateTime(h.createdAt)}</div>
                                    <div class="text-muted" style="font-size: 0.85rem;">${h.result || ''}</div>
                                </div>
                                <div class="history-elo ${cls}">${arrow} ${Math.abs(delta)} ELO</div>
                            </div>
                        `;
                    }).join('');
                    updateHistoryButtons();
                });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>



