<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Rulette Lie</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-user">
                <a href="profile.html" class="user-card">
                    <div class="user-avatar" id="sidebarAvatar">?</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-tag" id="sidebarTag">#00000</div>
                    </div>
                </a>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span>Home</span>
                </a>
                <a href="leaderboard.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    <span>Leaderboard</span>
                </a>
                <a href="friends.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Friends</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
                    <span>Rulette Lie</span>
                </div>
                <button class="btn btn-ghost btn-logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Profile Card -->
                <div class="card glass" style="padding: 0; overflow: hidden;">
                    <div class="profile-banner"></div>
                    <div class="profile-content" style="padding: 1.5rem;">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar" id="profileAvatar">?</div>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                            <button class="avatar-upload-btn" onclick="document.getElementById('avatarInput').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                            </button>
                        </div>
                        <div class="profile-info">
                            <h1 class="profile-name" id="profileName">Loading...</h1>
                            <p class="profile-tag" id="profileTag">#00000</p>
                            <p class="profile-full-id">Full ID: <span id="profileFullId">...</span></p>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid mt-3" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(34, 197, 94, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-green);">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                            </svg>
                        </div>
                        <p class="stat-value green" id="profileWins">0</p>
                        <p class="stat-label">Wins</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(239, 68, 68, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--error);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                        </div>
                        <p class="stat-value red" id="profileLosses">0</p>
                        <p class="stat-label">Losses</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-blue);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                        </div>
                        <p class="stat-value blue" id="profileTotal">0</p>
                        <p class="stat-label">Total Games</p>
                    </div>
                    <div class="card glass text-center" style="padding: 1.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="color: var(--neon-purple);">
                                <line x1="19" y1="5" x2="5" y2="19"></line>
                                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                                <circle cx="17.5" cy="17.5" r="2.5"></circle>
                            </svg>
                        </div>
                        <p class="stat-value purple" id="profileWinrate">0%</p>
                        <p class="stat-label">Win Rate</p>
                    </div>
                </div>

                <!-- Performance -->
                <div class="card glass mt-3">
                    <h3 class="card-title mb-2">Performance</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="text-muted">Win Rate</span>
                            <span id="perfWinrate">0%</span>
                        </div>
                        <div style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
                            <div id="winrateBar" style="height: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-pink)); border-radius: 6px; width: 0%; transition: width 1s ease;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <p class="text-muted" style="font-size: 0.85rem;">Games Won</p>
                            <p><span style="font-size: 1.5rem; font-weight: bold; color: var(--neon-green);" id="perfWins">0</span> <span class="text-muted" id="perfWinsTotal">/ 0</span></p>
                        </div>
                        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <p class="text-muted" style="font-size: 0.85rem;">Games Lost</p>
                            <p><span style="font-size: 1.5rem; font-weight: bold; color: var(--error);" id="perfLosses">0</span> <span class="text-muted" id="perfLossesTotal">/ 0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        let currentUser = null;
        const storage = firebase.storage();

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Subscribe to realtime updates
            db.collection('users').doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    currentUser = { id: doc.id, ...doc.data() };
                    updateUI();
                }
            });
        });

        function updateUI() {
            if (!currentUser) return;

            // Sidebar
            document.getElementById('sidebarName').textContent = currentUser.nickname;
            document.getElementById('sidebarTag').textContent = '#' + currentUser.suffix;
            document.getElementById('sidebarAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();
            
            // Profile
            document.getElementById('profileName').textContent = currentUser.nickname;
            document.getElementById('profileTag').textContent = '#' + currentUser.suffix;
            document.getElementById('profileFullId').textContent = formatNickname(currentUser.nickname, currentUser.suffix);
            document.getElementById('profileAvatar').textContent = currentUser.nickname.charAt(0).toUpperCase();

            if (currentUser.avatarUrl) {
                document.getElementById('sidebarAvatar').innerHTML = `<img src="${currentUser.avatarUrl}" alt="Avatar">`;
                document.getElementById('profileAvatar').innerHTML = `<img src="${currentUser.avatarUrl}" alt="Avatar">`;
            }

            // Stats
            const wins = currentUser.wins || 0;
            const losses = currentUser.losses || 0;
            const total = currentUser.totalGames || 0;
            const winrate = calculateWinrate(wins, losses);

            document.getElementById('profileWins').textContent = wins;
            document.getElementById('profileLosses').textContent = losses;
            document.getElementById('profileTotal').textContent = total;
            document.getElementById('profileWinrate').textContent = winrate + '%';

            // Performance
            document.getElementById('perfWinrate').textContent = winrate + '%';
            document.getElementById('winrateBar').style.width = winrate + '%';
            document.getElementById('perfWins').textContent = wins;
            document.getElementById('perfWinsTotal').textContent = '/ ' + total;
            document.getElementById('perfLosses').textContent = losses;
            document.getElementById('perfLossesTotal').textContent = '/ ' + total;
        }

        // Avatar upload
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showToast('File too large (max 5MB)', 'error');
                return;
            }

            try {
                showToast('Uploading...', 'info');
                const storageRef = storage.ref(`avatars/${currentUser.id}`);
                await storageRef.put(file);
                const downloadURL = await storageRef.getDownloadURL();

                await db.collection('users').doc(currentUser.id).update({
                    avatarUrl: downloadURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('Avatar updated!', 'success');
            } catch (error) {
                showToast('Upload failed', 'error');
                console.error(error);
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>

