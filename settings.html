<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Rulette Lie</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-user">
                <a href="profile.html" class="user-card">
                    <div class="user-avatar" id="sidebarAvatar">?</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-tag" id="sidebarTag">#00000</div>
                    </div>
                </a>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Home</span></a>
                <a href="leaderboard.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg><span>Leaderboard</span></a>
                <a href="friends.html" class="nav-item"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Friends</span></a>
                <a href="settings.html" class="nav-item active"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Settings</span><div class="nav-indicator"></div></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg><span>Rulette Lie</span></div>
                <button class="btn btn-ghost btn-logout" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>Sign Out</span></button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="page-header">
                    <h1 class="page-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        Settings
                    </h1>
                    <p class="page-subtitle">Manage your account and preferences</p>
                </div>

                <!-- Account -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            Account
                        </h3>
                    </div>
                    <p class="text-muted mb-2">Your account information</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="settingsEmail" disabled style="opacity: 0.6;">
                            <p class="form-hint">Email cannot be changed</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nickname</label>
                            <input type="text" class="form-input" id="settingsNickname" disabled style="opacity: 0.6;">
                            <p class="form-hint">Your unique tag: <span id="settingsTag">#00000</span></p>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Avatar URL</label>
                        <input type="url" class="form-input" id="settingsAvatarUrl" placeholder="https://media.discordapp.net/...">
                        <p class="form-hint">Paste a direct image link (e.g. Discord media). Leave empty to remove avatar.</p>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Bio / Opis</label>
                        <textarea class="form-input" id="settingsBio" rows="3" placeholder="Napisz coś o sobie..."></textarea>
                        <p class="form-hint">Max 200 znaków.</p>
                    </div>
                </div>

                <!-- Sound -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="color: var(--neon-cyan);"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            Sound
                        </h3>
                    </div>
                    <p class="text-muted mb-2">Audio preferences</p>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div>
                            <p style="font-weight: 500;">Game Sounds</p>
                            <p class="text-muted" style="font-size: 0.85rem;">Enable sound effects during gameplay</p>
                        </div>
                        <button class="btn btn-neon btn-sm" id="soundBtn" onclick="toggleSound()">Enabled</button>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="color: var(--neon-pink);"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                            Powiadomienia
                        </h3>
                    </div>
                    <p class="text-muted mb-2">Preferencje powiadomień</p>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div>
                            <p style="font-weight: 500;">Powiadomienia o zaproszeniach do znajomych</p>
                            <p class="text-muted" style="font-size: 0.85rem;">Wyświetlaj Notyfikacje, gdy ktoś wyśle ci zaproszenie do znajomych</p>
                        </div>
                        <button class="btn btn-neon btn-sm" id="notifBtn" onclick="toggleNotifications()">Enabled</button>
                    </div>
                </div>

                <!-- Security -->
                <div class="card glass">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="color: var(--neon-green);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            Security
                        </h3>
                    </div>
                    <p class="text-muted mb-2">Keep your account secure</p>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 1rem;">
                        <div>
                            <p style="font-weight: 500;">Password</p>
                            <p class="text-muted" style="font-size: 0.85rem;">Change your password</p>
                        </div>
                        <button class="btn btn-ghost btn-sm">Change</button>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 1rem 0;">
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px;">
                        <div>
                            <p style="font-weight: 500; color: var(--error);">Delete Account</p>
                            <p class="text-muted" style="font-size: 0.85rem;">Permanently delete your account and all data</p>
                        </div>
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </div>
                </div>

                <!-- Save -->
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button class="btn btn-neon btn-lg" onclick="saveSettings()">Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        let currentUser = null;
        let soundEnabled = true;
        let notificationsEnabled = true;

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                currentUser = { id: doc.id, ...doc.data() };
                updateSidebar();
                updateSettings();
            }
        });

        function renderAvatar(el, nickname, avatarUrl) {
            if (avatarUrl) {
                el.innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
                return;
            }
            el.textContent = (nickname || '?').charAt(0).toUpperCase();
        }

        function normalizeAvatarUrl(raw) {
            const trimmed = (raw || '').trim();
            if (!trimmed) return null;
            try {
                const url = new URL(trimmed);
                if (url.protocol !== 'http:' && url.protocol !== 'https:') return null;
                return url.toString();
            } catch (e) {
                return null;
            }
        }

        function updateSidebar() {
            document.getElementById('sidebarName').textContent = currentUser.nickname;
            document.getElementById('sidebarTag').textContent = '#' + currentUser.suffix;
            renderAvatar(document.getElementById('sidebarAvatar'), currentUser.nickname, currentUser.avatarUrl);
        }

        function updateSettings() {
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('settingsNickname').value = currentUser.nickname;
            document.getElementById('settingsTag').textContent = '#' + currentUser.suffix;
            document.getElementById('settingsAvatarUrl').value = currentUser.avatarUrl || '';
            document.getElementById('settingsBio').value = currentUser.bio || '';

            soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
            notificationsEnabled = currentUser.notificationsFriendRequests !== false;
            updateButtons();
        }

        function updateButtons() {
            const soundBtn = document.getElementById('soundBtn');
            const notifBtn = document.getElementById('notifBtn');

            soundBtn.textContent = soundEnabled ? 'Enabled' : 'Disabled';
            soundBtn.className = soundEnabled ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';

            notifBtn.textContent = notificationsEnabled ? 'Enabled' : 'Disabled';
            notifBtn.className = notificationsEnabled ? 'btn btn-neon btn-sm' : 'btn btn-ghost btn-sm';
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            updateButtons();
        }

        async function toggleNotifications() {
            notificationsEnabled = !notificationsEnabled;
            try {
                await db.collection('users').doc(currentUser.id).update({
                    notificationsFriendRequests: notificationsEnabled,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentUser.notificationsFriendRequests = notificationsEnabled;
                if (window.__currentUser) window.__currentUser.notificationsFriendRequests = notificationsEnabled;
            } catch (e) {
                showToast('BĹ‚Ä…d: ' + (e && e.message), 'error');
                notificationsEnabled = !notificationsEnabled;
            }
            updateButtons();
        }

        async function saveSettings() {
            const avatarInput = document.getElementById('settingsAvatarUrl');
            const avatarRaw = avatarInput.value;
            const avatarUrl = normalizeAvatarUrl(avatarRaw);
            const bioInput = document.getElementById('settingsBio');
            const bioRaw = (bioInput.value || '').trim();
            if (avatarRaw.trim() && !avatarUrl) {
                showToast('Nieprawidlowy link do obrazka.', 'error');
                return;
            }
            if (bioRaw.length > 200) {
                showToast('Bio jest zbyt dlugie (max 200 znakow).', 'error');
                return;
            }
            try {
                const updates = { updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                if ((currentUser.avatarUrl || null) !== (avatarUrl || null)) {
                    updates.avatarUrl = avatarUrl || null;
                }
                if ((currentUser.bio || '') !== bioRaw) {
                    updates.bio = bioRaw || null;
                }
                await db.collection('users').doc(currentUser.id).update(updates);
                currentUser.avatarUrl = avatarUrl || null;
                currentUser.bio = bioRaw || null;
                if (window.__currentUser) window.__currentUser.avatarUrl = currentUser.avatarUrl;
                renderAvatar(document.getElementById('sidebarAvatar'), currentUser.nickname, currentUser.avatarUrl);
                showToast('Zapisano!', 'success');
            } catch (e) {
                showToast('BĹ‚Ä…d: ' + (e && e.message), 'error');
            }
        }

        function logout() {
            auth.signOut().then(() => window.location.href = 'login.html');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const avatarInput = document.getElementById('settingsAvatarUrl');
            avatarInput.addEventListener('input', () => {
                const candidate = normalizeAvatarUrl(avatarInput.value);
                renderAvatar(document.getElementById('sidebarAvatar'), currentUser?.nickname || '?', candidate);
            });
        });
    </script>
</body>
</html>

